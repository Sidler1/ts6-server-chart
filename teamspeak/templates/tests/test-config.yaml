apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "teamspeak.fullname" . }}-test-config
  labels:
    {{- include "teamspeak.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "2"
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  template:
    spec:
      serviceAccountName: {{ include "teamspeak.serviceAccountName" . }}
      containers:
        - name: config-check
          image: busybox:1.35
          command:
            - /bin/sh
          args:
            - -c
            - |
              set -e
              echo "Verifying ConfigMap..."
              if [ -f /config/tsserver.yaml ]; then
                echo "ConfigMap mounted successfully"
                # Basic validation: check for required sections
                grep -q "voice_port:" /config/tsserver.yaml || (echo "Missing voice_port in config" && exit 1)
                grep -q "database:" /config/tsserver.yaml || (echo "Missing database section in config" && exit 1)
                {{- if .Values.mariadb.enabled }}
                grep -q "type: \"mariadb\"" /config/tsserver.yaml || (echo "Missing MariaDB config in tsserver.yaml" && exit 1)
                {{- else }}
                grep -q "type: \"sqlite\"" /config/tsserver.yaml || (echo "Missing SQLite config in tsserver.yaml" && exit 1)
                {{- end }}
                echo "ConfigMap validation passed!"
              else
                echo "ConfigMap not mounted" && exit 1
              fi
          volumeMounts:
            - name: config
              mountPath: /config
              readOnly: true
      volumes:
        - name: config
          configMap:
            name: {{ include "teamspeak.fullname" . }}-config
      restartPolicy: Never
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}